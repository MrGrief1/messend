<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Совместный документ</title>
    <link href="https://cdn.jsdelivr.net/npm/quill@1.3.7/dist/quill.snow.css" rel="stylesheet">
    <style>
        :root {
            color-scheme: dark;
        }
        html, body {
            height: 100%;
            margin: 0;
            background: #0d111a;
            color: #f9fafb;
            font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        }
        .pad-shell {
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        header {
            padding: 12px 20px;
            background: rgba(17, 21, 34, 0.94);
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 16px;
            flex-wrap: wrap;
        }
        header h1 {
            margin: 0;
            font-size: 16px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        header h1 svg {
            width: 20px;
            height: 20px;
        }
        header p {
            margin: 0;
            font-size: 13px;
            opacity: 0.75;
        }
        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 999px;
            background: rgba(129, 140, 248, 0.14);
            color: #818cf8;
            font-size: 12px;
        }
        .status-badge .dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: currentColor;
            box-shadow: 0 0 10px rgba(129, 140, 248, 0.6);
        }
        #toolbar {
            border: none;
            border-bottom: 1px solid rgba(255, 255, 255, 0.06);
            background: rgba(13, 17, 26, 0.85);
        }
        .ql-toolbar.ql-snow {
            border: none;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            padding: 10px 18px;
        }
        .ql-toolbar button {
            color: #e5e7eb !important;
        }
        .ql-toolbar button:hover {
            color: #fff !important;
        }
        #editor {
            flex: 1;
            overflow-y: auto;
            background: rgba(15, 23, 42, 0.6);
        }
        .ql-container.ql-snow {
            border: none !important;
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        .ql-editor {
            flex: 1;
            color: #f9fafb;
            font-size: 16px;
            line-height: 1.6;
            padding: 24px 28px;
        }
        .ql-editor.ql-blank::before {
            color: rgba(255, 255, 255, 0.4);
            font-style: normal;
        }
        footer {
            padding: 10px 20px;
            background: rgba(17, 21, 34, 0.94);
            border-top: 1px solid rgba(255, 255, 255, 0.08);
            font-size: 12px;
            color: rgba(255, 255, 255, 0.6);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        footer span {
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        footer svg {
            width: 14px;
            height: 14px;
        }
        @media (max-width: 768px) {
            header {
                padding: 12px 16px;
            }
            .ql-toolbar.ql-snow {
                padding: 8px 12px;
            }
            .ql-editor {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="pad-shell">
        <header>
            <div>
                <h1>
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6">
                        <path d="M6 2h9l5 5v15H6z" stroke-linejoin="round"></path>
                        <path d="M14 2v5h5" stroke-linecap="round" stroke-linejoin="round"></path>
                    </svg>
                    Документ Etherpad Lite
                </h1>
                <p id="documentStatus">Подготовка редактора…</p>
            </div>
            <div class="status-badge" id="syncBadge">
                <span class="dot"></span>
                <span id="syncText">Синхронизация</span>
            </div>
        </header>
        <div id="toolbar">
            <span class="ql-formats">
                <select class="ql-header">
                    <option selected></option>
                    <option value="2">Заголовок</option>
                    <option value="3">Подзаголовок</option>
                </select>
                <select class="ql-font"></select>
            </span>
            <span class="ql-formats">
                <button class="ql-bold"></button>
                <button class="ql-italic"></button>
                <button class="ql-underline"></button>
                <button class="ql-strike"></button>
            </span>
            <span class="ql-formats">
                <button class="ql-list" value="ordered"></button>
                <button class="ql-list" value="bullet"></button>
                <button class="ql-align" value=""></button>
                <button class="ql-align" value="center"></button>
                <button class="ql-align" value="right"></button>
            </span>
            <span class="ql-formats">
                <button class="ql-code-block"></button>
                <button class="ql-blockquote"></button>
                <button class="ql-clean"></button>
            </span>
        </div>
        <div id="editor"></div>
        <footer>
            <span>
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8">
                    <path d="M4 19h4l2 2h4l2-2h4V5H4z" stroke-linejoin="round"></path>
                    <path d="M8 9h8" stroke-linecap="round"></path>
                    <path d="M8 13h5" stroke-linecap="round"></path>
                </svg>
                Изменения сохраняются автоматически
            </span>
            <span id="collabCount">Совместный доступ активен</span>
        </footer>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/quill@1.3.7/dist/quill.min.js"></script>
    <script>
        const READY_EVENT = 'document:ready';
        const CONTENT_EVENT = 'document:content';
        const SET_EVENT = 'document:set';
        const FOCUS_EVENT = 'document:focus';

        const quill = new Quill('#editor', {
            theme: 'snow',
            placeholder: 'Начните печатать вместе с командой…',
            modules: {
                toolbar: '#toolbar',
                clipboard: {
                    matchVisual: false
                }
            }
        });

        const statusLabel = document.getElementById('documentStatus');
        const badge = document.getElementById('syncBadge');
        const badgeText = document.getElementById('syncText');
        let ignoreUpdates = false;
        let pendingTimer = null;
        let pendingHtml = null;

        const updateStatus = (text) => {
            if (statusLabel) {
                statusLabel.textContent = text;
            }
        };

        const setSyncActive = (active) => {
            if (!badge) return;
            badge.style.background = active ? 'rgba(34,197,94,0.18)' : 'rgba(129, 140, 248, 0.14)';
            badge.style.color = active ? '#34d399' : '#818cf8';
            if (badgeText) {
                badgeText.textContent = active ? 'Онлайн' : 'Синхронизация';
            }
        };

        const sendContentUpdate = (html) => {
            window.parent?.postMessage({ type: CONTENT_EVENT, payload: { html } }, '*');
        };

        quill.on('text-change', () => {
            if (ignoreUpdates) {
                return;
            }
            const html = quill.root.innerHTML;
            pendingHtml = html;
            updateStatus('Синхронизация…');
            setSyncActive(true);
            if (pendingTimer) window.clearTimeout(pendingTimer);
            pendingTimer = window.setTimeout(() => {
                sendContentUpdate(pendingHtml);
                updateStatus('Все изменения сохранены');
                pendingHtml = null;
            }, 220);
        });

        const applyRemoteContent = (html) => {
            if (typeof html !== 'string') return;
            ignoreUpdates = true;
            quill.clipboard.dangerouslyPasteHTML(html);
            ignoreUpdates = false;
            updateStatus('Подключено к документу');
            setSyncActive(true);
        };

        window.addEventListener('message', (event) => {
            if (!event.data || typeof event.data !== 'object') return;
            const { type, payload } = event.data;
            if (type === SET_EVENT) {
                applyRemoteContent(payload?.html || '');
            } else if (type === FOCUS_EVENT) {
                quill.focus();
            }
        });

        window.parent?.postMessage({ type: READY_EVENT }, '*');
        updateStatus('Редактор готов. Можно начинать.');
        setSyncActive(true);
    </script>
</body>
</html>
